{% extends "base.html" %}

{% block title %}Dashboard | Blood Health Advisor{% endblock %}

{% block content %}
<style>
    /* Dashboard Specific Styles */
    .glass-card {
        background: rgba(38, 40, 40, 0.6);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(119, 124, 124, 0.2);
        border-radius: 16px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .glass-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 20px rgba(0,0,0,0.4);
        border-color: var(--primary-color);
    }

    .metric-value {
        font-size: 2rem;
        font-weight: 700;
        color: #ffffff;
    }

    .status-badge {
        font-size: 0.75rem;
        padding: 4px 12px;
        border-radius: 20px;
        font-weight: 600;
    }

    .habit-row {
        padding: 12px;
        border-radius: 10px;
        background: rgba(255,255,255,0.03);
        margin-bottom: 8px;
        transition: 0.2s;
    }

    .habit-row:hover {
        background: rgba(50, 184, 198, 0.1);
    }

    .chart-container {
        position: relative;
        height: 220px;
    }

    /* Gradient Background for the Hero Section */
    .hero-stat {
        background: linear-gradient(135deg, rgba(50, 184, 198, 0.2) 0%, rgba(31, 33, 33, 0) 100%);
        border-left: 4px solid var(--primary-color);
    }
</style>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-end mb-4">
        <div>
            <h2 class="fw-bold mb-1">Health Insights</h2>
            <p class="text-muted mb-0">Analysis based on your report from {{ latest_report.uploaded_at|date:"M d, Y" }}</p>
        </div>
        <a href="{% url 'upload_report' %}" class="btn btn-primary d-none d-md-block">
            + Upload New Report
        </a>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="row g-3">
                {% for item in latest_values %}
                <div class="col-md-4 col-sm-6">
                    <div class="glass-card p-4 h-100">
                        <div class="d-flex justify-content-between mb-3">
                            <small class="text-muted text-uppercase ls-1 fw-bold">{{ item.parameter.name }}</small>
                            <span class="status-badge {% if item.status == 'Normal' %}bg-success-subtle text-success{% else %}bg-danger-subtle text-danger{% endif %}">
                                {{ item.status }}
                            </span>
                        </div>
                        <div class="metric-value mb-1">
                            {{ item.value }} <small class="fs-6 text-muted fw-normal">{{ item.unit }}</small>
                        </div>
                        
                        <div class="mt-3">
                            <div class="progress" style="height: 6px; background: rgba(255,255,255,0.1);">
                                <div class="progress-bar bg-primary" role="progressbar" 
                                     style="width: {{ item.position_percentage }}%; opacity: 0.8;"></div>
                            </div>
                            <div class="d-flex justify-content-between mt-2" style="font-size: 0.7rem;">
                                <span class="text-muted">{{ item.parameter.normal_min }}</span>
                                <span class="text-white-50">Optimal Range</span>
                                <span class="text-muted">{{ item.parameter.normal_max }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <h4 class="mt-5 mb-4 fw-bold">Historical Trends</h4>
            <div class="row g-4">
                {% for param, data in progress_data.items|slice:":2" %}
                <div class="col-md-6">
                    <div class="glass-card p-4">
                        <h6 class="mb-4 text-muted">{{ param }} Change over Time</h6>
                        <div class="chart-container">
                            <canvas id="chart_{{ forloop.counter }}"></canvas>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="col-lg-4">
            <div class="glass-card p-4 hero-stat mb-4">
                <div class="d-flex align-items-center">
                    <div class="fs-1 me-3">ðŸ”¥</div>
                    <div>
                        <h3 class="mb-0 fw-bold">{{ streak.current_streak|default:0 }} Days</h3>
                        <p class="text-muted small mb-0">Current Habit Streak</p>
                    </div>
                </div>
            </div>

            <div class="glass-card p-4 mb-4">
                <h5 class="fw-bold mb-4">Daily Actions</h5>
                {% if daily_habits %}
                    {% for habit in daily_habits %}
                    <div class="habit-row d-flex align-items-center">
                        <input class="form-check-input me-3" type="checkbox" 
                               style="width: 20px; height: 20px; background-color: transparent; border-color: var(--primary-color);"
                               {% if habit.completed %}checked{% endif %}>
                        <span class="small {% if habit.completed %}text-muted text-decoration-line-through{% endif %}">
                            {{ habit.habit_text }}
                        </span>
                    </div>
                    {% endfor %}
                    <button class="btn btn-outline-primary btn-sm w-100 mt-3">View All Habits</button>
                {% else %}
                    <div class="text-center py-3">
                        <p class="text-muted small">No habits assigned yet.</p>
                        <a href="{% url 'generate_recommendations' latest_report.id %}" class="btn btn-sm btn-primary">Generate Now</a>
                    </div>
                {% endif %}
            </div>

            <div class="glass-card p-4 border-primary border-opacity-25" style="border-style: dashed;">
                <h6 class="text-primary fw-bold mb-2">ðŸ’¡ AI Recommendation</h6>
                <p class="small text-muted mb-0">
                    {{ recommendation.daily_habits|truncatewords:20 }}
                </p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false },
            tooltip: {
                backgroundColor: '#262828',
                titleColor: '#32b8c6',
                bodyColor: '#f5f5f5',
                borderColor: 'rgba(119, 124, 124, 0.3)',
                borderWidth: 1,
                displayColors: false,
                padding: 12
            }
        },
        scales: {
            x: { 
                grid: { display: false },
                ticks: { color: 'rgba(167, 169, 169, 0.7)', font: { size: 10 } }
            },
            y: { 
                grid: { color: 'rgba(119, 124, 124, 0.1)' },
                ticks: { color: 'rgba(167, 169, 169, 0.7)', font: { size: 10 } }
            }
        },
        interaction: {
            intersect: false,
            mode: 'index',
        }
    };

    {% for param, data in progress_data.items|slice:":2" %}
    const ctx{{ forloop.counter }} = document.getElementById('chart_{{ forloop.counter }}').getContext('2d');
    
    // Create Gradient
    const gradient{{ forloop.counter }} = ctx{{ forloop.counter }}.createLinearGradient(0, 0, 0, 200);
    gradient{{ forloop.counter }}.addColorStop(0, 'rgba(50, 184, 198, 0.3)');
    gradient{{ forloop.counter }}.addColorStop(1, 'rgba(50, 184, 198, 0)');

    new Chart(ctx{{ forloop.counter }}, {
        type: 'line',
        data: {
            labels: {{ data.dates|safe }},
            datasets: [{
                data: {{ data.values|safe }},
                borderColor: '#32b8c6',
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                backgroundColor: gradient{{ forloop.counter }},
                pointBackgroundColor: '#32b8c6',
                pointHoverRadius: 7
            }]
        },
        options: chartOptions
    });
    {% endfor %}
});
</script>
{% endblock %}