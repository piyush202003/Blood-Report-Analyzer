{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Health Recommendations{% endblock %}

{% block content %}
<style>
    :root {
        --success-green: #10b981;
        --success-dark: #065f46;
        --danger-red: #ef4444;
        --danger-dark: #991b1b;
        --info-blue: #3b82f6;
        --info-dark: #1e40af;
        --warning-yellow: #f59e0b;
        --warning-dark: #92400e;
    }
    
    /* Report Header */
    .report-header {
        background: linear-gradient(135deg, var(--color-primary) 0%, #1d6b75 100%);
        color: white;
        padding: 2.5rem 2rem;
        border-radius: 16px;
        margin-bottom: 2rem;
        box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        text-align: center;
    }
    
    .report-header h2 {
        color: white;
        margin-bottom: 0.5rem;
        font-size: 2rem;
        font-weight: 600;
    }
    
    .report-meta {
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.9rem;
    }
    
    /* Info Cards - Light Theme Base */
    .info-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border-left: 4px solid var(--color-primary);
    }
    
    .info-card h4 {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: var(--color-text);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .info-card .icon {
        font-size: 1.5rem;
    }
    
    /* Simple Lists */
    .simple-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .simple-list li {
        padding: 0.75rem 0.75rem 0.75rem 2.5rem;
        position: relative;
        border-bottom: 1px solid rgba(0,0,0,0.08);
        line-height: 1.6;
        font-size: 0.95rem;
        color: #1f2937;
    }
    
    .simple-list li:last-child {
        border-bottom: none;
    }
    
    .simple-list li strong {
        color: #111827;
        font-weight: 600;
    }
    
    /* Icon bullets */
    .simple-list li:before {
        position: absolute;
        left: 0.5rem;
        font-size: 1.2rem;
        font-weight: bold;
    }
    
    .analysis-section .simple-list li:before {
        content: "üìå";
    }
    
    .foods-eat-section .simple-list li:before {
        content: "‚úÖ";
    }
    
    .foods-avoid-section .simple-list li:before {
        content: "‚ùå";
    }
    
    .habits-section .simple-list li:before {
        content: "üí°";
    }
    
    /* Color coded sections - Light Theme */
    .analysis-section {
        border-left-color: var(--info-blue);
        background: #eff6ff;
    }
    
    .foods-eat-section {
        border-left-color: var(--success-green);
        background: #f0fdf4;
    }
    
    .foods-avoid-section {
        border-left-color: var(--danger-red);
        background: #fef2f2;
    }
    
    .habits-section {
        border-left-color: var(--warning-yellow);
        background: #fffbeb;
    }
    
    .allergy-section {
        border-left-color: var(--warning-yellow);
        background: #fffbeb;
    }
    
    /* Allergy Badge */
    .allergy-badge {
        display: inline-block;
        padding: 0.4rem 0.9rem;
        margin: 0.3rem;
        background: #fef3c7;
        border: 1px solid var(--warning-yellow);
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--warning-dark);
    }
    
    /* Allergy section text */
    .allergy-section p,
    .allergy-section strong {
        color: #78350f;
    }
    
    /* Foods Grid */
    .foods-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    
    @media (min-width: 768px) {
        .foods-grid {
            grid-template-columns: 1fr 1fr;
        }
    }
    
    /* Disclaimer */
    .disclaimer {
        background: #f1f5f9;
        border-left: 4px solid var(--color-primary);
        padding: 1.25rem;
        border-radius: 8px;
        margin: 2rem 0;
        font-size: 0.9rem;
        color: #334155;
    }
    
    .disclaimer strong {
        color: #1e293b;
    }
    
    /* Action buttons */
    .action-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 2rem;
        margin-bottom: 3rem;
    }
    
    .action-buttons .btn {
        min-width: 200px;
    }
    
    /* Print button */
    .print-btn {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        z-index: 1000;
        transition: transform 0.2s;
    }
    
    .print-btn:hover {
        transform: scale(1.1);
    }
    
    /* ============================================
       DARK MODE STYLES
       ============================================ */
    
    @media (prefers-color-scheme: dark) {
        /* Info Cards - Dark Theme */
        .info-card {
            background: var(--color-surface);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .info-card h4 {
            color: var(--color-text);
        }
        
        /* Simple Lists - Dark Theme */
        .simple-list li {
            border-bottom: 1px solid rgba(255,255,255,0.1);
            color: #e5e7eb;
        }
        
        .simple-list li strong {
            color: #f9fafb;
        }
        
        /* Color coded sections - Dark Theme */
        .analysis-section {
            background: rgba(59, 130, 246, 0.15);
            border-left-color: #60a5fa;
        }
        
        .analysis-section h4 {
            color: #93c5fd;
        }
        
        .foods-eat-section {
            background: rgba(16, 185, 129, 0.15);
            border-left-color: #34d399;
        }
        
        .foods-eat-section h4 {
            color: #6ee7b7;
        }
        
        .foods-avoid-section {
            background: rgba(239, 68, 68, 0.15);
            border-left-color: #f87171;
        }
        
        .foods-avoid-section h4 {
            color: #fca5a5;
        }
        
        .habits-section {
            background: rgba(245, 158, 11, 0.15);
            border-left-color: #fbbf24;
        }
        
        .habits-section h4 {
            color: #fcd34d;
        }
        
        .allergy-section {
            background: rgba(245, 158, 11, 0.15);
            border-left-color: #fbbf24;
        }
        
        .allergy-section h4 {
            color: #fcd34d;
        }
        
        .allergy-section p,
        .allergy-section strong {
            color: #fde68a;
        }
        
        /* Allergy Badge - Dark Theme */
        .allergy-badge {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid #fbbf24;
            color: #fde68a;
        }
        
        /* Disclaimer - Dark Theme */
        .disclaimer {
            background: rgba(100, 116, 139, 0.2);
            border-left-color: var(--color-primary);
            color: #cbd5e1;
        }
        
        .disclaimer strong {
            color: #e2e8f0;
        }
    }
    
    /* Manual Dark Theme (data attribute) */
    [data-color-scheme="dark"] .info-card {
        background: var(--color-surface);
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    [data-color-scheme="dark"] .info-card h4 {
        color: var(--color-text);
    }
    
    [data-color-scheme="dark"] .simple-list li {
        border-bottom: 1px solid rgba(255,255,255,0.1);
        color: #e5e7eb;
    }
    
    [data-color-scheme="dark"] .simple-list li strong {
        color: #f9fafb;
    }
    
    [data-color-scheme="dark"] .analysis-section {
        background: rgba(59, 130, 246, 0.15);
        border-left-color: #60a5fa;
    }
    
    [data-color-scheme="dark"] .analysis-section h4 {
        color: #93c5fd;
    }
    
    [data-color-scheme="dark"] .foods-eat-section {
        background: rgba(16, 185, 129, 0.15);
        border-left-color: #34d399;
    }
    
    [data-color-scheme="dark"] .foods-eat-section h4 {
        color: #6ee7b7;
    }
    
    [data-color-scheme="dark"] .foods-avoid-section {
        background: rgba(239, 68, 68, 0.15);
        border-left-color: #f87171;
    }
    
    [data-color-scheme="dark"] .foods-avoid-section h4 {
        color: #fca5a5;
    }
    
    [data-color-scheme="dark"] .habits-section {
        background: rgba(245, 158, 11, 0.15);
        border-left-color: #fbbf24;
    }
    
    [data-color-scheme="dark"] .habits-section h4 {
        color: #fcd34d;
    }
    
    [data-color-scheme="dark"] .allergy-section {
        background: rgba(245, 158, 11, 0.15);
        border-left-color: #fbbf24;
    }
    
    [data-color-scheme="dark"] .allergy-section h4 {
        color: #fcd34d;
    }
    
    [data-color-scheme="dark"] .allergy-section p,
    [data-color-scheme="dark"] .allergy-section strong {
        color: #fde68a;
    }
    
    [data-color-scheme="dark"] .allergy-badge {
        background: rgba(245, 158, 11, 0.2);
        border: 1px solid #fbbf24;
        color: #fde68a;
    }
    
    [data-color-scheme="dark"] .disclaimer {
        background: rgba(100, 116, 139, 0.2);
        border-left-color: var(--color-primary);
        color: #cbd5e1;
    }
    
    [data-color-scheme="dark"] .disclaimer strong {
        color: #e2e8f0;
    }
    
    /* Print styles */
    @media print {
        .print-btn, .navbar, footer, .action-buttons {
            display: none !important;
        }
        .info-card {
            break-inside: avoid;
            box-shadow: none;
            border: 1px solid #ddd;
            background: white !important;
        }
        .simple-list li {
            color: #1f2937 !important;
        }
        body {
            font-size: 12pt;
            background: white !important;
        }
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
        .report-header {
            padding: 1.5rem 1rem;
        }
        .report-header h2 {
            font-size: 1.5rem;
        }
        .info-card {
            padding: 1rem;
        }
        .simple-list li {
            font-size: 0.9rem;
            padding-left: 2rem;
        }
        .action-buttons .btn {
            min-width: 100%;
        }
        .print-btn {
            bottom: 1rem;
            right: 1rem;
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
        }
    }
    
    /* Hover effects */
    .simple-list li {
        transition: background-color 0.2s ease;
    }
    
    .simple-list li:hover {
        background-color: rgba(33, 128, 141, 0.08);
    }
    
    @media (prefers-color-scheme: dark) {
        .simple-list li:hover {
            background-color: rgba(50, 184, 198, 0.15);
        }
    }
    
    [data-color-scheme="dark"] .simple-list li:hover {
        background-color: rgba(50, 184, 198, 0.15);
    }
</style>

<!-- Report Header -->
<div class="report-header">
    <h2>‚ú® Your Health Report Summary</h2>
    <p class="report-meta mb-1">AI-Powered Analysis & Actionable Recommendations</p>
    <p class="report-meta mb-0">
        <small>Generated: {{ recommendation.created_at|date:"M d, Y - h:i A" }}</small>
    </p>
</div>

<!-- Allergy Alert -->
{% if allergy_info.user_mentioned_allergies or allergy_info.common_allergies_response %}
<div class="info-card allergy-section">
    <h4>
        <span class="icon">‚ö†Ô∏è</span>
        Allergy Profile
    </h4>
    <p class="mb-2"><strong>All recommendations are personalized to avoid:</strong></p>
    
    {% if allergy_info.user_mentioned_allergies %}
        <p class="mb-2">
            <strong>Your Allergies:</strong> {{ allergy_info.user_mentioned_allergies }}
        </p>
    {% else %}
        <p class="mb-2">
            <strong>Your are strong. You don't have any alergies.</strong>
        </p>
    {% endif %}
    
    <div>
        {% for key, value in allergy_info.common_allergies_response.items %}
            {% if value %}
                <span class="allergy-badge">{{ key|title }}</span>
            {% endif %}
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Blood Report Analysis -->
<div class="info-card analysis-section">
    <h4>
        <span class="icon">üìä</span>
        Key Findings from Your Blood Report
    </h4>
    {{ recommendation.detailed_analysis|simple_list|safe }}
</div>

<!-- Foods Grid -->
<div class="foods-grid">
    <!-- Foods to Eat -->
    <div class="info-card foods-eat-section">
        <h4>
            <span class="icon">‚úÖ</span>
            Foods to Include
        </h4>
        {{ recommendation.foods_to_eat|simple_list|safe }}
    </div>
    
    <!-- Foods to Avoid -->
    <div class="info-card foods-avoid-section">
        <h4>
            <span class="icon">‚ùå</span>
            Foods to Avoid
        </h4>
        {{ recommendation.foods_to_avoid|simple_list|safe }}
    </div>
</div>

<!-- Daily Habits -->
<div class="info-card habits-section">
    <h4>
        <span class="icon">üí™</span>
        Daily Habits for Better Health
    </h4>
    {{ recommendation.daily_habits|simple_list|safe }}
</div>

<!-- Disclaimer -->
<div class="disclaimer">
    <strong>‚öïÔ∏è Medical Disclaimer:</strong>
    These are AI-generated suggestions based on your blood report. They do not replace professional medical advice. 
    Please consult your doctor before making any significant health changes.
</div>

<!-- Action Buttons -->
<div class="action-buttons">
    <a href="{% url 'upload_report' %}" class="btn btn-primary btn-lg">
        üì§ Upload New Report
    </a>
    <a href="{% url 'report_list' %}" class="btn btn-outline-secondary btn-lg">
        üìÅ All Reports
    </a>
    <a href="{% url 'progress_tracker' report_id=blood_report.id %}" class="btn btn-success btn-lg">
        üìä Track Progress
    </a>
    <a href="{% url 'download_pdf_report' report_id=blood_report.id %}" class="btn btn-danger btn-lg">
        üìÑ Download PDF
    </a>
    <button onclick="window.print()" class="btn btn-outline-info btn-lg">
        üñ®Ô∏è Print
    </button>
</div>

{% comment %} Chat bot assistant {% endcomment %}
<div class="glass-card mt-5 p-4">
    <h4 class="fw-bold mb-3" style="color: var(--primary-color);">
        <i class="bi bi-robot me-2"></i>Report Assistant
    </h4>
    
    <div id="chat-box" class="mb-3 p-3" style="height: 350px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 10px;">
        <div class="text-start mb-3">
            <div class="p-2 d-inline-block rounded shadow-sm" style="background: var(--surface-color); border: 1px solid var(--primary-color);">
                Hello! I've analyzed your report. You can ask me about your levels or dietary suggestions.
            </div>
        </div>
    </div>

    <div class="input-group">
        <input type="text" id="user-input" class="form-control bg-dark text-white border-secondary" 
               placeholder="Why is my Hemoglobin high?" onkeypress="if(event.key === 'Enter') sendMessage()">
        <button class="btn btn-primary" type="button" id="send-btn" onclick="sendMessage()">
            <span id="btn-text">Send</span>
            <span id="btn-spinner" class="spinner-border spinner-border-sm d-none"></span>
        </button>
    </div>
</div>

<script>
function sendMessage() {
    const input = document.getElementById('user-input');
    const chatBox = document.getElementById('chat-box');
    const sendBtn = document.getElementById('send-btn');
    const btnText = document.getElementById('btn-text');
    const btnSpinner = document.getElementById('btn-spinner');
    
    const msg = input.value.trim();
    if (!msg) return;

    // 1. Show User Message
    chatBox.innerHTML += `
        <div class="text-end mb-3">
            <div class="p-2 d-inline-block rounded bg-primary text-dark fw-bold">${msg}</div>
        </div>`;
    
    input.value = '';
    chatBox.scrollTop = chatBox.scrollHeight;

    // 2. Show Loading State
    sendBtn.disabled = true;
    btnText.classList.add('d-none');
    btnSpinner.classList.remove('d-none');

    // 3. AJAX Request
    // Note: Ensure report_id is available in your template context
    const reportId = "{{ blood_report.id }}"; 
    
    fetch(`/report/${reportId}/chat/`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ message: msg })
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
    })
    .then(data => {
        // 4. Show AI Response
        chatBox.innerHTML += `
            <div class="text-start mb-3">
                <div class="p-2 d-inline-block rounded" style="background: var(--surface-color); border: 1px solid rgba(255,255,255,0.1);">
                    ${data.response}
                </div>
            </div>`;
    })
    .catch(error => {
        console.error('Error:', error);
        chatBox.innerHTML += `<div class="text-center text-danger small">Error connecting to assistant.</div>`;
    })
    .finally(() => {
        // 5. Reset Button
        sendBtn.disabled = false;
        btnText.classList.remove('d-none');
        btnSpinner.classList.add('d-none');
        chatBox.scrollTop = chatBox.scrollHeight;
    });
}
</script>

<script>
window.scrollTo({ top: 0, behavior: 'smooth' });
</script>
{% endblock %}
